name: RustDesk with VNC & Tailscale Remote Access

on:
  workflow_dispatch:

jobs:
  setup-remote-access:
    runs-on: macos-latest
    timeout-minutes: 360

    steps:
      - name: Setup VNC with ARD
        run: |
          echo "=== Setting up Apple Remote Desktop/VNC ==="
          
          # Activate and configure ARD agent with full privileges
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -restart -agent -privs -all
          
          # Enable legacy VNC
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -clientopts -setvnclegacy -vnclegacy yes
          
          # Set VNC password (using a default password, change if needed)
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -clientopts -setvncpw myvncpassword -vncpw myvncpassword
          
          # Allow access for all users
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -allowAccessFor -allUsers
          
          echo "âœ… VNC/ARD setup complete"
          echo "VNC Password: myvncpassword"
          echo ""
          
          # Restart the service to apply changes
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -restart -agent
          
          sleep 5

      - name: Install and configure Tailscale
        run: |
          echo "=== Installing Tailscale ==="
          
          # Install Tailscale from official script
          curl -fsSL https://tailscale.com/install.sh | sh
          
          # Start tailscaled service
          echo "Starting tailscaled service..."
          sudo tailscaled 2>/dev/null || true
          
          # If command not found, try alternative paths
          if ! command -v tailscale &> /dev/null; then
            echo "Tailscale command not found, trying alternative..."
            
            # Try to start via the app
            sudo /Applications/Tailscale.app/Contents/MacOS/Tailscale --cleanup 2>/dev/null || true
            sudo tailscaled 2>/dev/null || true
            
            # If still not found, try Homebrew
            if ! command -v brew &> /dev/null; then
              echo "Installing Homebrew..."
              /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
            fi
            
            echo "Installing Tailscale via Homebrew..."
            brew install tailscale
            sudo brew services start tailscaled
          fi
          
          # Wait a moment for service to start
          sleep 3
          
          echo "âœ… Tailscale installation complete"

      - name: Authenticate Tailscale
        run: |
          echo "=== Authenticating Tailscale ==="
          
          # Auth key - replace with your actual key
          AUTH_KEY="tskey-auth-katBTfGaCP11CNTRL-hMqSUZh4fgPZNHebqNt7gPCxLc3sP2pf"
          
          echo "Authenticating with Tailscale..."
          
          # Try multiple times with delays
          for attempt in {1..5}; do
            echo "Authentication attempt $attempt..."
            
            if sudo tailscale up --authkey "$AUTH_KEY" 2>&1; then
              echo "âœ… Tailscale authentication successful"
              break
            else
              echo "Attempt $attempt failed, waiting..."
              sleep 5
            fi
          done
          
          # Wait for connection to establish
          echo "Waiting for Tailscale connection..."
          sleep 10

      - name: Get connection info
        run: |
          echo "=== Connection Information ==="
          
          # Get Tailscale status
          echo "Tailscale Status:"
          tailscale status 2>/dev/null || echo "Tailscale status command failed"
          
          # Get Tailscale IP
          echo ""
          echo "Tailscale IP:"
          tailscale ip 2>/dev/null || echo "Could not get Tailscale IP"
          
          # Get local network info
          echo ""
          echo "Local Network Info:"
          ifconfig | grep "inet " | grep -v 127.0.0.1 | head -5 || ipconfig getifaddr en0 || true
          
          # Check VNC port
          echo ""
          echo "VNC Service Status:"
          sudo lsof -i :5900 2>/dev/null || echo "VNC not listening on port 5900"
          echo "ARD/VNC should be accessible via: vnc://<ip>:5900"
          
          # Create connection info file
          INFO_FILE="$HOME/connection_info.txt"
          echo "Connection Information" > "$INFO_FILE"
          echo "=====================" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          echo "VNC Access:" >> "$INFO_FILE"
          echo "  Password: myvncpassword" >> "$INFO_FILE"
          echo "  Port: 5900" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          TAILSCALE_IP=$(tailscale ip 2>/dev/null || echo "Not available")
          echo "Tailscale IP: $TAILSCALE_IP" >> "$INFO_FILE"
          
          # Get public IP for reference
          PUBLIC_IP=$(curl -s ifconfig.me 2>/dev/null || echo "Not available")
          echo "Public IP: $PUBLIC_IP" >> "$INFO_FILE"
          
          echo "Connection info saved to: $INFO_FILE"

      - name: Install RustDesk
        run: |
          echo "=== Installing RustDesk ==="
          
          # Download and install RustDesk
          curl -L -o rustdesk.dmg "https://github.com/rustdesk/rustdesk/releases/download/1.4.4/rustdesk-1.4.4-x86_64.dmg"
          hdiutil attach rustdesk.dmg -mountpoint /Volumes/RustDesk -nobrowse
          sudo cp -R "/Volumes/RustDesk/RustDesk.app" /Applications/
          hdiutil detach /Volumes/RustDesk
          rm -f rustdesk.dmg
          
          echo "âœ… RustDesk installed"

      - name: Start RustDesk
        run: |
          echo "=== Starting RustDesk ==="
          
          # Start RustDesk
          open -a /Applications/RustDesk.app
          sleep 10
          
          # Check if running
          if pgrep -f "RustDesk" > /dev/null; then
            echo "âœ… RustDesk is running"
          else
            echo "âš ï¸ RustDesk may not have started properly"
          fi

      - name: Create screenshot directory
        run: |
          mkdir -p screenshots
          echo "SCREENSHOT_DIR=$(pwd)/screenshots" >> $GITHUB_ENV

      - name: Take initial screenshots
        run: |
          echo "=== Taking initial screenshots ==="
          
          # Take a few screenshots to verify everything works
          for i in {1..3}; do
            echo "Taking screenshot $i..."
            screenshot_file="$SCREENSHOT_DIR/initial_$i.png"
            screencapture -x "$screenshot_file" 2>/dev/null || true
            sleep 2
            
            if [ -f "$screenshot_file" ] && [ -s "$screenshot_file" ]; then
              size=$(ls -lh "$screenshot_file" | awk '{print $5}')
              echo "  Screenshot $i: ${size}"
            fi
          done

      - name: Upload connection info and screenshots
        uses: actions/upload-artifact@v4
        with:
          name: remote-access-info
          path: |
            $HOME/connection_info.txt
            ${{ env.SCREENSHOT_DIR }}
          retention-days: 1

      - name: Keep system running with periodic updates
        run: |
          echo "=== System is ready for remote access ==="
          echo ""
          echo "âœ… VNC/ARD Enabled"
          echo "   Password: myvncpassword"
          echo "   Port: 5900"
          echo ""
          echo "âœ… Tailscale VPN Active"
          echo "   Use 'tailscale ip' output to connect"
          echo ""
          echo "âœ… RustDesk Running"
          echo "   ID should be displayed in RustDesk window"
          echo ""
          echo "=== Keeping system alive ==="
          echo "This workflow will run for 6 hours (until timeout)"
          echo "System is now accessible remotely"
          echo ""
          echo "Current time: $(date)"
          echo "Will run until: $(date -v+6H)"
          echo ""
          
          # Display connection info periodically
          counter=0
          while true; do
            counter=$((counter + 1))
            minutes=$((counter * 5))
            
            echo ""
            echo "=== Status Update (${minutes} minutes elapsed) ==="
            echo "Time: $(date)"
            
            # Check services
            echo ""
            echo "Service Status:"
            
            # Check VNC
            if sudo lsof -i :5900 &>/dev/null; then
              echo "  âœ… VNC: Listening on port 5900"
            else
              echo "  âŒ VNC: Not listening"
            fi
            
            # Check Tailscale
            if tailscale status &>/dev/null; then
              echo "  âœ… Tailscale: Connected"
              TAILSCALE_IP=$(tailscale ip 2>/dev/null || echo "Unknown")
              echo "      IP: $TAILSCALE_IP"
            else
              echo "  âŒ Tailscale: Not connected"
            fi
            
            # Check RustDesk
            if pgrep -f "RustDesk" &>/dev/null; then
              echo "  âœ… RustDesk: Running"
            else
              echo "  âŒ RustDesk: Not running, restarting..."
              open -a /Applications/RustDesk.app 2>/dev/null || true
            fi
            
            # Take periodic screenshot
            if [ $((counter % 12)) -eq 0 ]; then # Every hour
              timestamp=$(date +%Y%m%d_%H%M%S)
              periodic_file="$SCREENSHOT_DIR/periodic_${timestamp}.png"
              screencapture -x "$periodic_file" 2>/dev/null || true
              echo "  ðŸ“¸ Periodic screenshot saved"
            fi
            
            # Sleep for 5 minutes
            echo ""
            echo "Next update in 5 minutes..."
            sleep 300
          done

      - name: Final cleanup
        if: always()
        run: |
          echo "=== Final Cleanup ==="
          echo "Stopping services..."
          
          # Stop RustDesk
          pkill -f "RustDesk" 2>/dev/null || true
          
          # Disconnect Tailscale
          sudo tailscale down 2>/dev/null || true
          
          # Stop VNC/ARD
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -deactivate -configure -access -off 2>/dev/null || true
          
          echo "âœ… Cleanup complete"
